{% extends "base.html" %}

{% block title %}Study Area{% endblock %}

{% block content %}
<div class="h-full w-full bg-gray-50 dark:bg-gray-800">
    <div class="h-full w-full p-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Study Area</h1>
            <p class="text-gray-600 dark:text-gray-300 mb-8">Begin a study session here.</p>
            
            <!-- Study Session Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Timer Card -->
                <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Study Timer</h2>
                    <div class="text-center">
                        <!-- Editable Timer Display -->
                        <div class="mb-4">
                            <label for="timer-display" class="text-gray-600 dark:text-gray-300 text-lg">Set Timer (mm:ss):</label>
                            <div id="timer-display" contenteditable="true" class="text-4xl font-bold mb-4 text-primary" 
                                role="textbox" aria-placeholder="00:00">25:00</div>
                        </div>
                        <!-- Pomodoro Controls -->
                        <div class="mt-4">
                            <label class="inline-flex items-center space-x-2 mb-4 group relative cursor-pointer">
                            <input type="checkbox" id="pomodoro-toggle" class="form-checkbox h-5 w-5 text-primary">
                            <span class="text-gray-800 dark:text-gray-200">Enable Pomodoro Mode</span>

                            <!-- Info Icon with Tooltip -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <title>How Pomodoro Mode Works</title>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                            </svg>

                            <!-- Tooltip -->
                            <div class="absolute bottom-full mb-2 hidden group-hover:block w-64 p-2 text-sm bg-gray-800 text-white rounded shadow-lg z-10">
                                Follows Pomodoro technique: 25 min work / 5 min break cycles. After 4 work sessions, you get a 15 min long break. Automatically transitions.
                            </div>
                        </label>

                            <p id="session-label" class="mt-2 text-sm text-primary font-semibold hidden">Current Session: Work</p>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button id="start-button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors duration-300">
                                Start
                            </button>
                            <button id="pause-button" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors duration-300">
                            Pause
                            </button>
                            <button id="reset-button" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors duration-300">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Session Stats and Goal Setting -->
                <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Today's Progress & Goal</h2>
                    <div class="space-y-4">
                        <!-- Today's Progress -->
                        <div>
                            <p class="text-gray-600 dark:text-gray-300">Total Study Time</p>
                            <p class="text-2xl font-bold text-primary">{{ total_time }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 dark:text-gray-300">Sessions Completed</p>
                            <p class="text-2xl font-bold text-primary">{{ completed_sessions }}</p>
                        </div>
                        
                        <!-- Goal Setting -->
                        <div class="mt-4">
                            <label for="goal-hours" class="text-gray-600 dark:text-gray-300">Set Daily Study Goal (hours):</label>
                            <input type="number" id="goal-hours" min="1" class="w-full px-4 py-2 border border-primary text-primary rounded-lg" placeholder="Enter goal in hours" />
                        </div>
                        
                        <!-- Submit Button for Goal Settings -->
                        <div class="mt-4">
                            <button id="set-goal-button" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors duration-300">
                                Set Goal
                            </button>
                        </div>

                        <!-- Progress Tracker -->
                        <div class="mt-4">
                            <p class="text-gray-600 dark:text-gray-300">Progress</p>
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                                <div id="progress-bar" class="h-4 bg-primary rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-lg font-semibold text-primary" id="progress-text">0% Complete</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Quick Actions</h2>
                    <div class="space-y-4">
                        <a href="{{ url_for('study_session') }}">
                        <button class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors duration-300">
                            Log Study Session
                        </button>
                        </a>
                        
                        <a href="{{ url_for('study_history') }}">
                        <button class="w-full px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors duration-300">
                            View History
                        </button>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Elements
    let goalHoursInput = document.getElementById('goal-hours');
    let progressBar = document.getElementById('progress-bar');
    let progressText = document.getElementById('progress-text');
    let setGoalButton = document.getElementById('set-goal-button');

    // Get total study time in minutes from Flask
    let totalStudyTime = {{ total_time_minutes|default(0) }};


    function updateProgress() {
        let goalHours = parseFloat(goalHoursInput.value) || 0;
        let timeGoalInMinutes = goalHours * 60;

        let progress = timeGoalInMinutes > 0 ? (totalStudyTime / timeGoalInMinutes) * 100 : 0;
        progress = Math.min(100, progress);  // Cap at 100%

        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${Math.round(progress)}% Complete`;
    }

    setGoalButton.addEventListener('click', updateProgress);

    // Initial update on page load (if goal is already filled in)
    window.addEventListener('DOMContentLoaded', updateProgress);
</script>
<script>
    let timerDisplay = document.getElementById('timer-display');
    let startButton = document.getElementById('start-button');
    let pauseButton = document.getElementById('pause-button');
    let resetButton = document.getElementById('reset-button');
    let pomodoroToggle = document.getElementById('pomodoro-toggle');
    let sessionLabel = document.getElementById('session-label');

    let timerInterval;
    let remainingSeconds = 0;
    let startTimestamp = null;
    let totalDuration = null;
    let isPaused = false;

    // Pomodoro states
    let pomodoroEnabled = false;
    let sessionCount = 0;
    let isWorkSession = true;

    function parseTime(displayText) {
        const [minutes, seconds] = displayText.split(':').map(Number);
        return (minutes * 60) + (seconds || 0);
    }

    function formatTime(seconds) {
        const m = String(Math.floor(seconds / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        return `${m}:${s}`;
    }

    function updateDisplay() {
        timerDisplay.textContent = formatTime(remainingSeconds);
    }

    function setSessionLabel() {
        if (!pomodoroEnabled) {
            sessionLabel.classList.add('hidden');
            return;
        }

        sessionLabel.classList.remove('hidden');
        if (isWorkSession) {
            sessionLabel.textContent = `Current Session: Work (${sessionCount % 4 + 1}/4)`;
        } else if (sessionCount % 4 === 0) {
            sessionLabel.textContent = "Current Session: Long Break";
        } else {
            sessionLabel.textContent = "Current Session: Short Break";
        }
    }

    function startNextPomodoroSession() {
        isWorkSession = !isWorkSession;
        if (isWorkSession) {
            sessionCount++;
        }

        if (isWorkSession) {
            remainingSeconds = 25 * 60;
        } else if (sessionCount % 4 === 0) {
            remainingSeconds = 15 * 60;
        } else {
            remainingSeconds = 5 * 60;
        }

        updateDisplay();
        setSessionLabel();
    }

    startButton.addEventListener('click', () => {
        pomodoroEnabled = pomodoroToggle.checked;

        if (!timerInterval) {
            if (!isPaused) {
                if (pomodoroEnabled) {
                    if (remainingSeconds <= 0) {
                        startNextPomodoroSession();
                    }
                } else {
                    remainingSeconds = parseTime(timerDisplay.textContent);
                }
                totalDuration = remainingSeconds;
                startTimestamp = Date.now();
                localStorage.setItem('timer_start', startTimestamp);
                localStorage.setItem('timer_duration', totalDuration);
                localStorage.setItem('timer_running', 'true');
            }

            isPaused = false;
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateDisplay();

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    localStorage.removeItem('timer_running');
                    if (pomodoroEnabled) {
                        startNextPomodoroSession();
                        startButton.click(); // auto-start next session
                    } else {
                        alert('Time is up!');
                    }
                }
            }, 1000);
        }
    });


    pauseButton.addEventListener('click', () => {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            isPaused = true;
        }
        localStorage.setItem('timer_running', 'paused');
        localStorage.setItem('timer_remaining', remainingSeconds);

    });

    resetButton.addEventListener('click', () => {
        clearInterval(timerInterval);
        timerInterval = null;
        isPaused = false;

        localStorage.removeItem('timer_running');
        localStorage.removeItem('timer_start');
        localStorage.removeItem('timer_duration');
        localStorage.removeItem('timer_remaining');

        pomodoroEnabled = pomodoroToggle.checked;
        sessionCount = 0;
        isWorkSession = true;
        remainingSeconds = 25 * 60;
        updateDisplay();
        setSessionLabel();
    });

    window.addEventListener('DOMContentLoaded', () => {
        const runningState = localStorage.getItem('timer_running');

        if (runningState === 'true') {
            const start = parseInt(localStorage.getItem('timer_start'), 10);
            const duration = parseInt(localStorage.getItem('timer_duration'), 10);
            const now = Date.now();
            const elapsed = Math.floor((now - start) / 1000);
            remainingSeconds = Math.max(0, duration - elapsed);

            updateDisplay();

            if (remainingSeconds > 0) {
                startButton.click(); // restart interval
            } else {
                localStorage.removeItem('timer_running');
                alert('Time is up!');
            }

        } else if (runningState === 'paused') {
            remainingSeconds = parseInt(localStorage.getItem('timer_remaining'), 10) || 25 * 60;
            updateDisplay();
        } else {
            remainingSeconds = 25 * 60;
            updateDisplay();
        }
    });


    // On load
    remainingSeconds = 25 * 60;
    updateDisplay();
</script>

{% endblock %}
