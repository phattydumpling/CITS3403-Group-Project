{% extends "base.html" %}

{% block title %}Study Area{% endblock %}

{% block content %}
<div class="h-full w-full bg-gray-50 dark:bg-gray-800">
    <div class="h-full w-full p-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">Study Area</h1>
            <p class="text-gray-600 dark:text-gray-300 mb-8">Begin a study session here.</p>
            
            <!-- Study Session Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Timer Card -->
                <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Study Timer</h2>
                    <div class="text-center">
                        <!-- Editable Timer Display -->
                        <div class="mb-4">
                            <label for="timer-display" class="text-gray-600 dark:text-gray-300 text-lg">Set Timer (mm:ss):</label>
                            <div id="timer-display" contenteditable="true" class="text-4xl font-bold mb-4 text-primary" 
                                role="textbox" aria-placeholder="00:00">25:00</div>
                        </div>

                        <div class="flex justify-center space-x-4">
                            <button id="start-button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors duration-300">
                                Start
                            </button>
                            <button id="pause-button" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors duration-300">
                            Pause
                            </button>
                            <button id="reset-button" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors duration-300">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Session Stats and Goal Setting -->
                <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Today's Progress & Goal</h2>
                    <div class="space-y-4">
                        <!-- Today's Progress -->
                        <div>
                            <p class="text-gray-600 dark:text-gray-300">Total Study Time</p>
                            <p class="text-2xl font-bold text-primary">{{ total_time }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 dark:text-gray-300">Sessions Completed</p>
                            <p class="text-2xl font-bold text-primary">{{ completed_sessions }}</p>
                        </div>
                        
                        <!-- Goal Setting -->
                        <div class="mt-4">
                            <label for="goal-hours" class="text-gray-600 dark:text-gray-300">Set Daily Study Goal (hours):</label>
                            <input type="number" id="goal-hours" min="1" class="w-full px-4 py-2 border border-primary text-primary rounded-lg" placeholder="Enter goal in hours" />
                        </div>
                        
                        <!-- Submit Button for Goal Settings -->
                        <div class="mt-4">
                            <button id="set-goal-button" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors duration-300">
                                Set Goal
                            </button>
                        </div>

                        <!-- Progress Tracker -->
                        <div class="mt-4">
                            <p class="text-gray-600 dark:text-gray-300">Progress</p>
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                                <div id="progress-bar" class="h-4 bg-primary rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-lg font-semibold text-primary" id="progress-text">0% Complete</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Quick Actions</h2>
                    <div class="space-y-4">
                        <a href="{{ url_for('study_session') }}">
                        <button class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors duration-300">
                            Log Study Session
                        </button>
                        </a>
                        
                        <a href="{{ url_for('study_history') }}">
                        <button class="w-full px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors duration-300">
                            View History
                        </button>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Elements
    let goalHoursInput = document.getElementById('goal-hours');
    let progressBar = document.getElementById('progress-bar');
    let progressText = document.getElementById('progress-text');
    let setGoalButton = document.getElementById('set-goal-button');

    // Get total study time in minutes from Flask
    let totalStudyTime = {{ total_time_minutes|default(0) }};


    function updateProgress() {
        let goalHours = parseFloat(goalHoursInput.value) || 0;
        let timeGoalInMinutes = goalHours * 60;

        let progress = timeGoalInMinutes > 0 ? (totalStudyTime / timeGoalInMinutes) * 100 : 0;
        progress = Math.min(100, progress);  // Cap at 100%

        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${Math.round(progress)}% Complete`;
    }

    setGoalButton.addEventListener('click', updateProgress);

    // Initial update on page load (if goal is already filled in)
    window.addEventListener('DOMContentLoaded', updateProgress);
</script>

<script>
    let timerDisplay = document.getElementById('timer-display');
    let startButton = document.getElementById('start-button');
    let pauseButton = document.getElementById('pause-button');
    let resetButton = document.getElementById('reset-button');

    let timerInterval = null;
    let remainingSeconds = 0;
    let initialSeconds = 0; // stores original time when Start is first pressed

    function parseTimeFromDisplay() {
        let [minutes, seconds] = timerDisplay.textContent.trim().split(':').map(Number);
        return (isNaN(minutes) ? 0 : minutes) * 60 + (isNaN(seconds) ? 0 : seconds);
    }

    function updateDisplay(seconds) {
        let mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        let secs = String(seconds % 60).padStart(2, '0');
        timerDisplay.textContent = `${mins}:${secs}`;
    }

    function startTimer() {
        if (timerInterval) return; // Already running

        // If it's the first start (initialSeconds not set), capture original
        if (initialSeconds === 0) {
            initialSeconds = parseTimeFromDisplay();
        }

        if (remainingSeconds === 0) {
            remainingSeconds = initialSeconds;
        }

        timerInterval = setInterval(() => {
            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                return;
            }
            remainingSeconds--;
            updateDisplay(remainingSeconds);
        }, 1000);
    }

    function pauseTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    function resetTimer() {
        pauseTimer();
        remainingSeconds = 0;
        updateDisplay(initialSeconds || parseTimeFromDisplay()); // revert to original
        initialSeconds = 0; // allow fresh Start
    }

    startButton.addEventListener('click', startTimer);
    pauseButton.addEventListener('click', pauseTimer);
    resetButton.addEventListener('click', resetTimer);

    //PERSISTENCE ACROSS RELOADS (continuous countdown) ---

    // Save state when the page is unloaded
    window.addEventListener('beforeunload', () => {
        localStorage.setItem('studyTimer_remainingSeconds', remainingSeconds);
        localStorage.setItem('studyTimer_initialSeconds', initialSeconds);
        localStorage.setItem('studyTimer_startTimestamp', Date.now()); // time now in ms
        localStorage.setItem('studyTimer_isRunning', !!timerInterval);
    });

    // Restore on load
    window.addEventListener('DOMContentLoaded', () => {
        const savedInitial = parseInt(localStorage.getItem('studyTimer_initialSeconds')) || 0;
        const savedRemaining = parseInt(localStorage.getItem('studyTimer_remainingSeconds')) || 0;
        const wasRunning = localStorage.getItem('studyTimer_isRunning') === 'true';
        const savedTimestamp = parseInt(localStorage.getItem('studyTimer_startTimestamp'));

        if (savedInitial > 0) {
            initialSeconds = savedInitial;

            if (wasRunning && savedTimestamp) {
                const elapsedSeconds = Math.floor((Date.now() - savedTimestamp) / 1000);
                remainingSeconds = Math.max(0, savedRemaining - elapsedSeconds);

                updateDisplay(remainingSeconds);
                if (remainingSeconds > 0) startTimer(); // Resume countdown
            } else {
                remainingSeconds = savedRemaining;
                updateDisplay(remainingSeconds);
            }
        }
    });
</script>


{% endblock %}