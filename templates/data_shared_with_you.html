{% extends "base.html" %}
{% block title %}Data Shared With You{% endblock %}
{% block content %}
<div class="h-full w-full bg-gray-50 dark:bg-gray-800">
    <div class="h-full w-full p-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white dark:bg-gray-700 rounded-2xl shadow-lg p-8 border border-gray-100 dark:border-gray-600">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-xl bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center mr-4">
                        <i class="fas fa-inbox text-2xl text-indigo-600 dark:text-indigo-300"></i>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Shared Data</h2>
                </div>

                {% if data_shared_with_you %}
                    {% set user_data = {} %}
                    {% for data in data_shared_with_you %}
                        {% if data.from_user.id not in user_data %}
                            {% set _ = user_data.update({data.from_user.id: {'user': data.from_user, 'shares': []}}) %}
                        {% endif %}
                        {% set _ = user_data[data.from_user.id]['shares'].append(data) %}
                    {% endfor %}

                    <div class="space-y-6">
                        {% for user_id, user_info in user_data.items() %}
                            <div class="bg-gray-50 dark:bg-gray-600 rounded-xl overflow-hidden">
                                <!-- User Header -->
                                <div class="p-4 flex items-center justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors duration-200" 
                                     onclick="toggleUserSection('user-{{ user_id }}')">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-14 h-14 rounded-full bg-indigo-600 flex items-center justify-center text-xl font-bold text-white">
                                            {{ user_info.user.username[0]|upper }}
                                        </div>
                                        <div>
                                            <h3 class="font-medium text-gray-900 dark:text-white text-lg">{{ user_info.user.username }}</h3>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ user_info.shares|length }} share{{ 's' if user_info.shares|length != 1 else '' }}</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200" id="icon-{{ user_id }}"></i>
                                </div>

                                <!-- User's Shared Data -->
                                <div class="hidden max-h-[600px] overflow-y-auto" id="user-{{ user_id }}">
                                    {% set study_data = [] %}
                                    {% set mood_data = [] %}
                                    {% set tasks_data = [] %}
                                    
                                    {% for data in user_info.shares|sort(attribute='created_at', reverse=true) %}
                                        {% if data.data_content.get('study_progress') %}
                                            {% set _ = study_data.append(data) %}
                                        {% endif %}
                                        {% if data.data_content.get('mood') %}
                                            {% set _ = mood_data.append(data) %}
                                        {% endif %}
                                        {% if data.data_content.get('tasks') %}
                                            {% set _ = tasks_data.append(data) %}
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Study Progress Section -->
                                    {% if study_data %}
                                    <div class="border-t border-gray-200 dark:border-gray-500">
                                        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/30 cursor-pointer hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors duration-200" 
                                             onclick="toggleDataTypeSection('study-{{ user_id }}')">
                                            <div class="flex items-center justify-between">
                                                <h4 class="font-medium text-gray-900 dark:text-white flex items-center">
                                                    <i class="fas fa-book-open mr-2 text-indigo-600"></i>
                                                    Study Progress
                                                </h4>
                                                <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200" id="icon-study-{{ user_id }}"></i>
                                            </div>
                                        </div>
                                        <div id="study-{{ user_id }}">
                                            {% for data in study_data %}
                                            <div class="p-6 border-t border-gray-200 dark:border-gray-500">
                                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Shared {{ data.created_at_awst.strftime('%Y-%m-%d %H:%M') }}</p>
                                                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow-sm">
                                                    <script type="application/json" id="studyData_{{ data.id }}">{{ data.data_content.study_progress|tojson }}</script>
                                                    <canvas id="studyChart_{{ data.id }}" class="w-full h-64"></canvas>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Mood Tracking Section -->
                                    {% if mood_data %}
                                    <div class="border-t border-gray-200 dark:border-gray-500">
                                        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/30 cursor-pointer hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors duration-200" 
                                             onclick="toggleDataTypeSection('mood-{{ user_id }}')">
                                            <div class="flex items-center justify-between">
                                                <h4 class="font-medium text-gray-900 dark:text-white flex items-center">
                                                    <i class="fas fa-face-smile mr-2 text-indigo-600"></i>
                                                    Mood Tracking
                                                </h4>
                                                <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200" id="icon-mood-{{ user_id }}"></i>
                                            </div>
                                        </div>
                                        <div id="mood-{{ user_id }}">
                                            {% for data in mood_data %}
                                            <div class="p-6 border-t border-gray-200 dark:border-gray-500">
                                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Shared {{ data.created_at_awst.strftime('%Y-%m-%d %H:%M') }}</p>
                                                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow-sm">
                                                    <script type="application/json" id="moodData_{{ data.id }}">{{ data.data_content.mood|tojson }}</script>
                                                    <canvas id="moodChart_{{ data.id }}" class="w-full h-64"></canvas>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Tasks Section -->
                                    {% if tasks_data %}
                                    <div class="border-t border-gray-200 dark:border-gray-500">
                                        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/30 cursor-pointer hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors duration-200" 
                                             onclick="toggleDataTypeSection('tasks-{{ user_id }}')">
                                            <div class="flex items-center justify-between">
                                                <h4 class="font-medium text-gray-900 dark:text-white flex items-center">
                                                    <i class="fas fa-tasks mr-2 text-indigo-600"></i>
                                                    Completed Tasks
                                                </h4>
                                                <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200" id="icon-tasks-{{ user_id }}"></i>
                                            </div>
                                        </div>
                                        <div id="tasks-{{ user_id }}">
                                            {% for data in tasks_data %}
                                            <div class="p-6 border-t border-gray-200 dark:border-gray-500">
                                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Shared {{ data.created_at_awst.strftime('%Y-%m-%d %H:%M') }}</p>
                                                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 shadow-sm">
                                                    <script type="application/json" id="tasksData_{{ data.id }}">{{ data.data_content.tasks|tojson }}</script>
                                                    <canvas id="tasksChart_{{ data.id }}" class="w-full h-64"></canvas>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-6 text-gray-400">
                            <i class="fas fa-inbox text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-3">No Data Shared With You</h3>
                        <p class="text-gray-500 dark:text-gray-400">Your friends haven't shared any data with you yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/data_shared_charts.js') }}"></script>
{% endblock %}
{% endblock %} 